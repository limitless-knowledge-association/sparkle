<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audit Trail - Sparkle</title>
  <style id="injected-common-css"></style>
  <link rel="stylesheet" href="sparkle-base.css">
  <link rel="stylesheet" href="audit-common.css">
  <style>
    /* Audit Trail-specific styles */
    .item-header {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .item-header h2 {
      font-size: 24px;
      color: #667eea;
      margin-bottom: 10px;
    }

    .item-id {
      font-family: monospace;
      color: #764ba2;
      font-size: 14px;
      margin-bottom: 10px;
      padding: 4px 8px;
      background: rgba(118, 75, 162, 0.1);
      border-radius: 4px;
      display: inline-block;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
    }

    .item-id:hover {
      background: rgba(118, 75, 162, 0.2);
    }

    .item-tagline {
      font-size: 16px;
      color: #666;
      margin-bottom: 15px;
    }

    .btn-open-details {
      padding: 10px 16px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-open-details:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="item-header">
      <h2>Audit Trail</h2>
      <div id="itemId" class="item-id" onclick="copyItemId()" title="Click to copy">Loading...</div>
      <div id="itemTagline" class="item-tagline">Loading...</div>
      <button class="btn-open-details" onclick="openItemDetails()">Open Item Details</button>
    </div>

    <div class="section">
      <h3>Audit Events</h3>
      <div id="auditTrailContent">
        <div class="loading-state">Loading audit trail...</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeHeader, connectToServer, loadBranchStatus, loadVersion, getCommonCSS, subscribeToEvent, showToast } from './sparkle-common.js';
    import { ConfigurationSettings } from './ConfigurationSettings.js';
    import { initializeItemEditor, openItemEditor } from './item-editor.js';
    import { AuditController } from './AuditController.js';
    import { AuditTrailView } from './AuditTrailView.js';

    let currentItemId = null;

    // Configuration settings instance
    const configSettings = new ConfigurationSettings();

    // Inject common CSS
    document.getElementById('injected-common-css').textContent = getCommonCSS();

    // Initialize header (no navigation - standalone window)
    initializeHeader();

    // Initialize item editor (for opening from this page)
    initializeItemEditor();

    // API helper
    async function apiCall(endpoint, body = null) {
      const options = {
        method: body ? 'POST' : 'GET',
        headers: body ? { 'Content-Type': 'application/json' } : {}
      };

      if (body) {
        options.body = JSON.stringify(body);
      }

      const response = await fetch(endpoint, options);
      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || 'Request failed');
      }

      return result;
    }

    // Get item ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    currentItemId = urlParams.get('itemId');

    if (!currentItemId) {
      document.getElementById('auditTrailContent').innerHTML = '<div class="error-state">No item ID provided. Please navigate from the main page.</div>';
    } else {
      // Create MVC components
      const controller = new AuditController(apiCall, subscribeToEvent);
      const view = new AuditTrailView('auditTrailContent');

      // Wire controller to view
      controller.onDataChanged((entries) => {
        view.render(entries);
      });

      // Override refresh to load for this specific item
      controller.refresh = async function() {
        await this.loadForItem(currentItemId);
      };

      // Subscribe to SSE updates
      controller.subscribeToUpdates();

      // Initialize
      (async function init() {
        // Initialize configuration and subscribe to changes
        await configSettings.initialize();
        configSettings.onChange((config) => {
          // Apply dark mode when configuration changes
          const applyDarkMode = (enabled) => {
            document.body.classList.toggle('dark-mode', enabled);
          };
          applyDarkMode(config.darkMode);
        });

        // Connect to SSE for live updates
        connectToServer();

        // Load initial data
        loadItemInfo();

        view.renderLoading();
        try {
          await controller.loadForItem(currentItemId);
        } catch (error) {
          view.renderError(error.message);
        }

        // Load status info
        loadBranchStatus();
        loadVersion();
      })();
    }

    // Make functions globally available
    window.copyItemId = copyItemId;
    window.openItemDetails = openItemDetails;

    /**
     * Load item info (ID and tagline)
     */
    async function loadItemInfo() {
      try {
        const details = await apiCall('/api/getItemDetails', { itemId: currentItemId });

        document.getElementById('itemId').textContent = details.itemId;
        document.getElementById('itemTagline').textContent = details.tagline || '(no tagline)';

        // Update page title
        document.title = `Audit Trail: ${details.itemId} - Sparkle`;
      } catch (error) {
        console.error('Failed to load item info:', error);
      }
    }

    /**
     * Copy item ID to clipboard
     */
    async function copyItemId() {
      if (!currentItemId) return;

      try {
        await navigator.clipboard.writeText(currentItemId);
        showToast('Item ID copied to clipboard');
      } catch (error) {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = currentItemId;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          showToast('Item ID copied to clipboard');
        } catch (err) {
          showToast('Failed to copy Item ID', 'error');
        }
        document.body.removeChild(textArea);
      }
    }

    /**
     * Open item details modal
     */
    function openItemDetails() {
      if (!currentItemId) return;
      openItemEditor(currentItemId);
    }
  </script>
</body>
</html>
