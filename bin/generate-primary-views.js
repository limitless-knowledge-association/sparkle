#!/usr/bin/env node

/**
 * Generate primaryViews.js by scanning HTML files for sparkle-view metadata
 * This script runs during prepack to automatically build the navigation dropdown
 */

import { readdir, readFile, writeFile } from 'fs/promises';
import { join, dirname } from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const publicDir = join(__dirname, '../public');
const outputFile = join(publicDir, 'primaryViews.js');

async function scanHtmlFiles() {
  const views = [];

  try {
    // Read all files in public directory
    const files = await readdir(publicDir);
    const htmlFiles = files.filter(f => f.endsWith('.html'));

    console.log(`Scanning ${htmlFiles.length} HTML files for primary views...`);

    for (const file of htmlFiles) {
      const filePath = join(publicDir, file);
      const content = await readFile(filePath, 'utf-8');

      // Look for the sparkle-view meta tag
      // Pattern: <meta name="sparkle-view" content="primary" data-view-name="Display Name">
      const metaRegex = /<meta\s+name=["']sparkle-view["']\s+content=["']primary["']\s+data-view-name=["']([^"']+)["']\s*\/?>/i;
      const match = content.match(metaRegex);

      if (match) {
        const viewName = match[1];
        views.push({
          name: viewName,
          url: file
        });
        console.log(`  ✓ Found primary view: "${viewName}" in ${file}`);
      }
    }

    // Sort views alphabetically by name
    views.sort((a, b) => a.name.localeCompare(b.name));

    console.log(`\nFound ${views.length} primary views`);
    return views;

  } catch (error) {
    console.error('Error scanning HTML files:', error);
    throw error;
  }
}

async function generateOutputFile(views) {
  const output = `/**
 * Primary Views Registry
 *
 * This file is auto-generated by bin/generate-primary-views.js
 * DO NOT EDIT MANUALLY - your changes will be overwritten
 *
 * To add a new primary view:
 * 1. Add this meta tag to your HTML file's <head> section:
 *    <meta name="sparkle-view" content="primary" data-view-name="Your View Name">
 * 2. Run 'npm run release' or 'npm pack' to regenerate this file
 */

export const primaryViews = ${JSON.stringify(views, null, 2)};
`;

  try {
    await writeFile(outputFile, output, 'utf-8');
    console.log(`\n✓ Generated ${outputFile}`);
  } catch (error) {
    console.error('Error writing output file:', error);
    throw error;
  }
}

async function main() {
  console.log('Generating primary views registry...\n');

  const views = await scanHtmlFiles();
  await generateOutputFile(views);

  console.log('\n✅ Primary views generation complete!');
}

main().catch(error => {
  console.error('Fatal error:', error);
  process.exit(1);
});
